{"version":3,"file":"heatmap.js","sources":["../src/utils.ts","../src/canvas2d.ts","../src/store.ts","../src/index.ts"],"sourcesContent":["import { HeatmapConfig, PointInfo } from './typings'\n\nconst defaultConfig: HeatmapConfig = {\n  gradient: {\n    0.25: 'rgb(0,0,255)',\n    0.55: 'rgb(0,255,0)',\n    0.85: 'yellow',\n    1.0: 'rgb(255,0,0)'\n  },\n  maxOpacity: 1,\n  minOpacity: 0,\n  blur: 0.85,\n  container: null\n}\n\nexport function mergeConfig(customConfig: HeatmapConfig) {\n  return Object.assign({}, defaultConfig, customConfig)\n}\n\nexport function getColorPalette(config: HeatmapConfig) {\n  const gradientConfig = config.gradient\n  const paletteCanvas = document.createElement('canvas')\n  const paletteCtx = paletteCanvas.getContext('2d')\n\n  paletteCanvas.width = 256\n  paletteCanvas.height = 1\n\n  const gradient = paletteCtx.createLinearGradient(0, 0, 256, 1)\n  Object.keys(gradientConfig).forEach(key => {\n    gradient.addColorStop(+key, gradientConfig[key])\n  })\n\n  paletteCtx.fillStyle = gradient\n  paletteCtx.fillRect(0, 0, 256, 1)\n\n  return paletteCtx.getImageData(0, 0, 256, 1).data\n}\n\nexport function getXY(point: PointInfo): number[] {\n  const pos = point.position\n  return [pos.left + pos.width / 2, pos.top + pos.height / 2]\n}\n\n/**\n * 将点信息合并，保留面积更大的\n * @param source\n * @param target\n */\nexport function mergeInfo(source: PointInfo, target: PointInfo): PointInfo {\n  let position = source.position\n  if (position.width * position.height <\n    target.position.width * target.position.height) {\n    position = target.position\n  }\n\n  return {\n    position,\n    value: source.value + target.value\n  }\n}\n","import { HeatmapConfig, HeatData, PointInfo, Position } from './typings'\nimport { getColorPalette } from './utils'\n\nconst getPointTemplate = function(pos: Position, blurFactor: number, globalAlpha: number): HTMLCanvasElement {\n  const tplCanvas = document.createElement('canvas')\n  const tplCtx = tplCanvas.getContext('2d')\n  tplCanvas.width = pos.width\n  tplCanvas.height = pos.height\n  const sideLen = Math.max(pos.height, pos.width)\n  const radius = sideLen / 2\n\n  tplCtx.scale(pos.width / sideLen, pos.height / sideLen)\n  if (+blurFactor >= 1) {\n    tplCtx.beginPath()\n    tplCtx.arc(radius, radius, radius, 0, Math.PI * 2)\n    tplCtx.fillStyle = 'rgba(0,0,0,1)'\n    tplCtx.globalAlpha = globalAlpha\n    tplCtx.fill()\n  } else {\n    const gradient = tplCtx.createRadialGradient(radius, radius, radius * blurFactor, radius, radius, radius)\n    gradient.addColorStop(0, 'rgba(0,0,0,1)')\n    gradient.addColorStop(1, 'rgba(0,0,0,0)')\n    tplCtx.fillStyle = gradient\n    tplCtx.globalAlpha = globalAlpha\n    tplCtx.fillRect(0, 0, sideLen, sideLen)\n  }\n  return tplCanvas\n}\n\nclass Canvas2dRenderer {\n  private canvas: HTMLCanvasElement\n  private shadowCanvas: HTMLCanvasElement\n  private ctx: CanvasRenderingContext2D\n\n  private palette: Uint8ClampedArray\n  private templates: any\n\n  private min: number\n  private max: number\n  private width: number\n  private height: number\n\n  constructor(private config: HeatmapConfig) {\n    const container = config.container\n    this.canvas = document.createElement('canvas')\n    this.shadowCanvas = document.createElement('canvas')\n    this.ctx = this.canvas.getContext('2d')\n\n    this.min = 0\n    this.max = 1\n    this.templates = {}\n    this.palette = getColorPalette(config)\n    this.config.blur = (config.blur === 0) ? 0 : config.blur\n\n    this.setStyles(config)\n    container.style.position = 'relative'\n    container.appendChild(this.canvas)\n  }\n\n  private setStyles(config: HeatmapConfig) {\n    const computed = window.getComputedStyle(this.config.container)\n    this.width = this.canvas.width = this.shadowCanvas.width = +(computed.width.replace(/px/, ''))\n    this.height = this.canvas.height = this.shadowCanvas.height = +(computed.height.replace(/px/, ''))\n    this.canvas.className = 'heatmap-canvas'\n    this.canvas.style.cssText = 'position:absolute;left:0;top:0;'\n\n    if (config.backgroundColor) {\n      this.canvas.style.backgroundColor = config.backgroundColor\n    }\n  }\n\n  private clear() {\n    this.ctx.clearRect(0, 0, this.width, this.height)\n  }\n\n  private drawAlpha(heatData: HeatData) {\n    const min = this.min = heatData.min\n    const max = this.max = heatData.max\n    const points = heatData.data || []\n    const blur = 1 - this.config.blur\n    const ctx = this.ctx\n\n    points.forEach((point: PointInfo) => {\n      const top = point.position.top\n      const left = point.position.left\n\n      const value = Math.min(point.value, max)\n\n      const templateAlpha = (value - min) / (max - min)\n      const globalAlpha = templateAlpha < 0.01 ? 0.01 : templateAlpha\n\n      const key = point.position.width + ':' + point.position.height + ':' + point.value\n      let tpl\n      if (!this.templates[key]) {\n        this.templates[key] = tpl = getPointTemplate(point.position, blur, globalAlpha)\n      } else {\n        tpl = this.templates[key]\n      }\n\n      this.colorize(tpl)\n      ctx.drawImage(tpl, left, top)\n    })\n  }\n\n  /**\n   * 用画板给黑白的热图染色\n   */\n  private colorize(canvas: HTMLCanvasElement) {\n    const width = canvas.width\n    const height = canvas.height\n    const ctx = canvas.getContext('2d')\n    const img = ctx.getImageData(0, 0, width, height)\n    const imgData = img.data\n    const palette = this.palette\n\n    for (let i = 3; i < imgData.length; i += 4) {\n      const alpha = imgData[i]\n      const offset = alpha * 4\n\n      if (!offset) {\n        continue\n      }\n\n      const finalAlpha = this.computeAlpha(alpha)\n\n      imgData[i - 3] = palette[offset]\n      imgData[i - 2] = palette[offset + 1]\n      imgData[i - 1] = palette[offset + 2]\n      imgData[i] = finalAlpha // palette[offset + 3]\n    }\n    ctx.putImageData(img, 0, 0)\n  }\n\n  /**\n   * 根据灰度值计算最终图片的明亮度\n   * @param alpha 黑白图灰度\n   */\n  private computeAlpha(alpha: number) {\n    const opacity = (this.config.opacity || 0) * 255\n    const maxOpacity = this.config.maxOpacity * 255\n    const minOpacity = this.config.minOpacity * 255\n    let finalAlpha\n    if (opacity > 0) {\n      finalAlpha = opacity\n    } else {\n      if (alpha < maxOpacity) {\n        if (alpha < minOpacity) {\n          finalAlpha = minOpacity\n        } else {\n          finalAlpha = alpha\n        }\n      } else {\n        finalAlpha = maxOpacity\n      }\n    }\n    return finalAlpha\n  }\n\n  public renderPartial(data: HeatData) {\n    if (data.data.length > 0) {\n      this.drawAlpha(data)\n    }\n  }\n\n  public renderAll(data: HeatData) {\n    this.clear()\n    this.renderPartial(data)\n  }\n\n  public getDataURL(): string {\n    return this.canvas.toDataURL()\n  }\n}\n\nexport default Canvas2dRenderer\n","import {\n  HeatData,\n  HeatmapConfig, PointInfo\n} from './typings'\nimport Canvas2dRenderer from './canvas2d'\nimport { getXY, mergeInfo } from './utils'\n\ntype PointData = { [K: string]: PointInfo }\n\nclass Store {\n  private min: number\n  private max: number\n  private pointData: PointData\n  private defaultRect = { width: 40, height: 40 }\n\n  constructor(\n    private config: HeatmapConfig,\n    private renderer: Canvas2dRenderer\n  ) {\n    this.min = 0\n    this.max = 1\n    this.pointData = {}\n  }\n\n  private specRect(point: PointInfo): PointInfo {\n    const position = point.position\n    if (!position.height || !position.width) {\n      Object.assign(position, this.defaultRect)\n    }\n    return point\n  }\n\n  /**\n   * 对同一个点的数据进行合并，并更新极值\n   * @param points  点信息\n   * @return pointData 新增的点信息\n   */\n  private organiseData(points: PointInfo[]): PointData {\n    const pointData: PointData = {}\n    points.forEach(point => {\n      point = this.specRect(point)\n      const [x, y] = getXY(point)\n      const key = x + ':' + y\n      const value = point.value\n\n      const prev = this.pointData[key]\n      if (prev) {\n        this.pointData[key] = pointData[key] = mergeInfo(prev, point)\n      } else {\n        this.pointData[key] = pointData[key] = point\n      }\n      this.min = Math.min(value, this.min)\n      this.max = Math.max(value, this.max)\n    })\n    return pointData\n  }\n\n  public addData(data: PointInfo | PointInfo[]): Store {\n    if (!Array.isArray(data)) {\n      data = [data]\n    }\n    const min = this.min\n    const max = this.max\n    const newPd = this.organiseData(data)\n    if (min === this.min && max === this.max) {\n      this.renderer.renderPartial({\n        min,\n        max,\n        data: Object.values(newPd)\n      })\n    } else {\n      this.repaint()\n    }\n    return this\n  }\n\n  public setData(data: HeatData) {\n    this.max = data.max\n    this.min = data.min || 0\n    this.organiseData(data.data)\n    this.repaint()\n    return this\n  }\n\n  public setExtremum(min: number, max: number, render = false) {\n    this.min = min\n    this.max = max\n    render && this.renderer.renderAll(this.getInternalData())\n  }\n\n  public getInternalData(): HeatData {\n    return {\n      min: this.min,\n      max: this.max,\n      data: Object.values(this.pointData)\n    }\n  }\n\n  public repaint() {\n    this.onExtremaChange()\n    this.renderer.renderAll(this.getInternalData())\n  }\n\n  private onExtremaChange() {\n    this.config.onExtremaChange && this.config.onExtremaChange({\n      min: this.min,\n      max: this.max,\n      gradient: this.config.gradient\n    })\n  }\n}\n\nexport default Store\n","import {\n  HeatData,\n  HeatmapConfig, PointInfo\n} from './typings'\nimport { mergeConfig } from './utils'\nimport Canvas2dRenderer from './canvas2d'\nimport Store from './store'\n\nclass Heatmap {\n  public config: HeatmapConfig\n  private store: Store\n  public renderer: Canvas2dRenderer\n\n  constructor(config: HeatmapConfig) {\n    this.config = mergeConfig(config)\n    this.renderer = new Canvas2dRenderer(this.config)\n    this.store = new Store(this.config, this.renderer)\n  }\n\n  public addData(data: PointInfo | PointInfo[]): Heatmap {\n    this.store.addData(data)\n    return this\n  }\n\n  public setData(data: HeatData): Heatmap {\n    this.store.setData(data)\n    return this\n  }\n\n  public setExtremum(min: number, max: number): Heatmap {\n    this.store.setExtremum(min, max, true)\n    return this\n  }\n\n  public repaint() {\n    this.store.repaint()\n    return this\n  }\n\n  public getDataURL(): string {\n    return this.renderer.getDataURL()\n  }\n}\n\nexport default Heatmap\n"],"names":["defaultConfig","gradient","maxOpacity","minOpacity","blur","container","mergeConfig","customConfig","Object","assign","getColorPalette","config","gradientConfig","paletteCanvas","document","createElement","paletteCtx","getContext","width","height","createLinearGradient","keys","forEach","key","addColorStop","fillStyle","fillRect","getImageData","data","getXY","point","pos","position","left","top","mergeInfo","source","target","value","getPointTemplate","blurFactor","globalAlpha","tplCanvas","tplCtx","sideLen","Math","max","radius","scale","beginPath","arc","PI","fill","createRadialGradient","Canvas2dRenderer","constructor","canvas","shadowCanvas","ctx","min","templates","palette","setStyles","style","appendChild","computed","window","getComputedStyle","replace","className","cssText","backgroundColor","clear","clearRect","drawAlpha","heatData","points","templateAlpha","tpl","colorize","drawImage","img","imgData","i","length","alpha","offset","finalAlpha","computeAlpha","putImageData","opacity","renderPartial","renderAll","getDataURL","toDataURL","Store","renderer","pointData","specRect","defaultRect","organiseData","x","y","prev","addData","Array","isArray","newPd","values","repaint","setData","setExtremum","render","getInternalData","onExtremaChange","Heatmap","store"],"mappings":"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"}