{"version":3,"file":"heatmap.js","sources":["../src/utils.ts","../src/canvas2d.ts","../src/store.ts","../src/index.ts"],"sourcesContent":["import { HeatmapConfig, PointInfo, Position } from './typings'\r\n\r\nconst defaultConfig: HeatmapConfig = {\r\n  gradient: {\r\n    0.25: 'rgb(0,0,255)',\r\n    0.55: 'rgb(0,255,0)',\r\n    0.85: 'yellow',\r\n    1.0: 'rgb(255,0,0)'\r\n  },\r\n  maxOpacity: 1,\r\n  minOpacity: 0,\r\n  blur: 0.85,\r\n  container: null\r\n}\r\n\r\nexport function mergeConfig(customConfig: HeatmapConfig) {\r\n  return Object.assign({}, defaultConfig, customConfig)\r\n}\r\n\r\nexport function getColorPalette(config: HeatmapConfig) {\r\n  const gradientConfig = config.gradient\r\n  const paletteCanvas = document.createElement('canvas')\r\n  const paletteCtx = paletteCanvas.getContext('2d')\r\n\r\n  paletteCanvas.width = 256\r\n  paletteCanvas.height = 1\r\n\r\n  const gradient = paletteCtx.createLinearGradient(0, 0, 256, 1)\r\n  Object.keys(gradientConfig).forEach(key => {\r\n    gradient.addColorStop(+key, gradientConfig[key])\r\n  })\r\n\r\n  paletteCtx.fillStyle = gradient\r\n  paletteCtx.fillRect(0, 0, 256, 1)\r\n\r\n  return paletteCtx.getImageData(0, 0, 256, 1).data\r\n}\r\n\r\nfunction pointRound(num: number): number {\r\n  return Math.round(num / 10) * 10\r\n}\r\n\r\nexport function getXY(point: PointInfo): number[] {\r\n  const pos = point.position\r\n  return [pointRound(pos.left + pos.width / 2) >> 0, pointRound(pos.top + pos.height / 2) >> 0]\r\n}\r\n\r\n/**\r\n * 比较两个面积的大小\r\n *\r\n * @param source\r\n * @param target\r\n * @return 0 一般大 >0 source更大 <0 target更大\r\n */\r\nexport function compareArea(source: Position, target: Position): number {\r\n  return source.width * source.height - target.width * target.height\r\n}\r\n\r\n/**\r\n * 将点信息合并，保留面积更大的\r\n * @param source\r\n * @param target\r\n */\r\nexport function mergeInfo(source: PointInfo, target: PointInfo): PointInfo {\r\n  let position = source.position\r\n  if (compareArea(position, target.position) < 0) {\r\n    position = target.position\r\n  }\r\n\r\n  return {\r\n    position,\r\n    value: source.value + target.value\r\n  }\r\n}\r\n","import { HeatmapConfig, HeatData, PointInfo, Position } from './typings'\r\nimport { getColorPalette } from './utils'\r\n\r\nfunction getPointTemplate(pos: Position, blurFactor: number, globalAlpha: number): HTMLCanvasElement {\r\n  const tplCanvas = document.createElement('canvas')\r\n  const tplCtx = tplCanvas.getContext('2d')\r\n  tplCanvas.width = pos.width\r\n  tplCanvas.height = pos.height\r\n  const sideLen = Math.max(pos.height, pos.width)\r\n  const radius = sideLen / 2\r\n\r\n  tplCtx.scale(pos.width / sideLen, pos.height / sideLen)\r\n  if (+blurFactor >= 1) {\r\n    tplCtx.beginPath()\r\n    tplCtx.arc(radius, radius, radius, 0, Math.PI * 2)\r\n    tplCtx.fillStyle = 'rgba(0,0,0,1)'\r\n    tplCtx.globalAlpha = globalAlpha\r\n    tplCtx.fill()\r\n  } else {\r\n    const gradient = tplCtx.createRadialGradient(radius, radius, radius * blurFactor, radius, radius, radius)\r\n    gradient.addColorStop(0, 'rgba(0,0,0,1)')\r\n    gradient.addColorStop(1, 'rgba(0,0,0,0)')\r\n    tplCtx.fillStyle = gradient\r\n    tplCtx.globalAlpha = globalAlpha\r\n    tplCtx.fillRect(0, 0, sideLen, sideLen)\r\n  }\r\n  return tplCanvas\r\n}\r\n\r\nclass Canvas2dRenderer {\r\n  public canvas: HTMLCanvasElement\r\n  private shadowCanvas: HTMLCanvasElement\r\n  private ctx: CanvasRenderingContext2D\r\n\r\n  private palette: Uint8ClampedArray\r\n  private templates: any\r\n\r\n  private min: number\r\n  private max: number\r\n  private width: number\r\n  private height: number\r\n\r\n  constructor(private config: HeatmapConfig) {\r\n    const container = config.container\r\n    this.canvas = document.createElement('canvas')\r\n    this.shadowCanvas = document.createElement('canvas')\r\n    this.ctx = this.canvas.getContext('2d')\r\n\r\n    this.min = 0\r\n    this.max = 1\r\n    this.templates = {}\r\n    this.palette = getColorPalette(config)\r\n    this.config.blur = (config.blur === 0) ? 0 : config.blur\r\n\r\n    this.setStyles(config)\r\n    container.style.position = 'relative'\r\n    container.appendChild(this.canvas)\r\n  }\r\n\r\n  private setStyles(config: HeatmapConfig) {\r\n    const computed = window.getComputedStyle(this.config.container)\r\n    let width = +(computed.width.replace(/px/, ''))\r\n    let height = +(computed.height.replace(/px/, ''))\r\n    if (config.width && config.height) {\r\n      width = Math.max(config.width, width)\r\n      height = Math.max(config.height, height)\r\n    }\r\n\r\n    this.width = this.canvas.width = this.shadowCanvas.width = width\r\n    this.height = this.canvas.height = this.shadowCanvas.height = height\r\n    this.canvas.className = 'gio-heatmap-canvas'\r\n    this.canvas.style.cssText = 'position:absolute;left:0;top:0;z-index:1999999;'\r\n\r\n    if (config.backgroundColor) {\r\n      this.canvas.style.backgroundColor = config.backgroundColor\r\n    }\r\n  }\r\n\r\n  private clear() {\r\n    this.ctx.clearRect(0, 0, this.width, this.height)\r\n  }\r\n\r\n  private drawAlpha(heatData: HeatData) {\r\n    const min = this.min = heatData.min\r\n    const max = this.max = heatData.max\r\n    const points = heatData.data || []\r\n    const blur = 1 - this.config.blur\r\n    const ctx = this.ctx\r\n\r\n    points.forEach((point: PointInfo) => {\r\n      const top = point.position.top\r\n      const left = point.position.left\r\n\r\n      const value = Math.min(point.value, max)\r\n\r\n      const templateAlpha = (value - min) / (max - min)\r\n      const globalAlpha = templateAlpha < 0.01 ? 0.01 : templateAlpha\r\n\r\n      const key = point.position.width + ':' + point.position.height + ':' + point.value\r\n      let tpl\r\n      if (!this.templates[key]) {\r\n        this.templates[key] = tpl = getPointTemplate(point.position, blur, globalAlpha)\r\n      } else {\r\n        tpl = this.templates[key]\r\n      }\r\n\r\n      this.colorize(tpl)\r\n      ctx.drawImage(tpl, left, top)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 用画板给黑白的热图染色\r\n   */\r\n  private colorize(canvas: HTMLCanvasElement) {\r\n    const width = canvas.width\r\n    const height = canvas.height\r\n    const ctx = canvas.getContext('2d')\r\n    const img = ctx.getImageData(0, 0, width, height)\r\n    const imgData = img.data\r\n    const palette = this.palette\r\n\r\n    for (let i = 3; i < imgData.length; i += 4) {\r\n      const alpha = imgData[i]\r\n      const offset = alpha * 4\r\n\r\n      if (!offset) {\r\n        continue\r\n      }\r\n\r\n      const finalAlpha = this.computeAlpha(alpha)\r\n\r\n      imgData[i - 3] = palette[offset]\r\n      imgData[i - 2] = palette[offset + 1]\r\n      imgData[i - 1] = palette[offset + 2]\r\n      imgData[i] = finalAlpha // palette[offset + 3]\r\n    }\r\n    ctx.putImageData(img, 0, 0)\r\n  }\r\n\r\n  /**\r\n   * 计算透明度\r\n   * @param alpha 当前透明度 A的值\r\n   */\r\n  private computeAlpha(alpha: number) {\r\n    const opacity = (this.config.opacity || 0) * 255\r\n    const maxOpacity = this.config.maxOpacity * 255\r\n    const minOpacity = this.config.minOpacity * 255\r\n    let finalAlpha\r\n    if (opacity > 0) {\r\n      finalAlpha = opacity\r\n    } else {\r\n      if (alpha < maxOpacity) {\r\n        if (alpha < minOpacity) {\r\n          finalAlpha = minOpacity\r\n        } else {\r\n          finalAlpha = alpha\r\n        }\r\n      } else {\r\n        finalAlpha = maxOpacity\r\n      }\r\n    }\r\n    return finalAlpha\r\n  }\r\n\r\n  public renderPartial(data: HeatData) {\r\n    if (data.data.length > 0) {\r\n      this.drawAlpha(data)\r\n    }\r\n  }\r\n\r\n  public renderAll(data: HeatData) {\r\n    this.clear()\r\n    this.renderPartial(data)\r\n  }\r\n\r\n  public getDataURL(): string {\r\n    return this.canvas.toDataURL()\r\n  }\r\n}\r\n\r\nexport default Canvas2dRenderer\r\n","import {\r\n  HeatData,\r\n  HeatmapConfig, PointInfo\r\n} from './typings'\r\nimport Canvas2dRenderer from './canvas2d'\r\nimport { getXY, mergeInfo } from './utils'\r\n\r\ntype PointData = { [K: string]: PointInfo }\r\n\r\nclass Store {\r\n  private min: number\r\n  private max: number\r\n  private pointData: PointData\r\n  private defaultRect = { width: 40, height: 40 }\r\n\r\n  constructor(\r\n    private config: HeatmapConfig,\r\n    private renderer: Canvas2dRenderer\r\n  ) {\r\n    this.min = 0\r\n    this.max = 1\r\n    this.pointData = {}\r\n  }\r\n\r\n  private inferRect(point: PointInfo): PointInfo {\r\n    const position = point.position\r\n    if (!position.height || !position.width) {\r\n      Object.assign(position, this.defaultRect)\r\n    }\r\n    return point\r\n  }\r\n\r\n  /**\r\n   * 对同一个点的数据进行合并，并更新极值\r\n   * @param points  点信息\r\n   * @return pointData 新增的点信息\r\n   */\r\n  private organiseData(points: PointInfo[]): PointData {\r\n    const pointData: PointData = {}\r\n    points.forEach(point => {\r\n      point = this.inferRect(point)\r\n      const [x, y] = getXY(point)\r\n      const key = x + ':' + y\r\n      const prev = this.pointData[key]\r\n      if (prev) {\r\n        this.pointData[key] = pointData[key] = mergeInfo(prev, point)\r\n      } else {\r\n        this.pointData[key] = pointData[key] = point\r\n      }\r\n      const value = this.pointData[key].value\r\n\r\n      this.min = Math.min(value, this.min)\r\n      this.max = Math.max(value, this.max)\r\n    })\r\n    return pointData\r\n  }\r\n\r\n  public addData(data: PointInfo | PointInfo[]): Store {\r\n    if (!Array.isArray(data)) {\r\n      data = [data]\r\n    }\r\n    const min = this.min\r\n    const max = this.max\r\n    const newPd = this.organiseData(data)\r\n    if (min === this.min && max === this.max) {\r\n      this.renderer.renderPartial({\r\n        min,\r\n        max,\r\n        data: Object.values(newPd)\r\n      })\r\n    } else {\r\n      this.repaint()\r\n    }\r\n    return this\r\n  }\r\n\r\n  public setData(data: HeatData) {\r\n    this.max = data.max\r\n    this.min = data.min || 0\r\n    this.organiseData(data.data)\r\n    this.repaint()\r\n    return this\r\n  }\r\n\r\n  public setExtremum(min: number, max: number, render = false) {\r\n    this.min = min\r\n    this.max = max\r\n    render && this.renderer.renderAll(this.getInternalData())\r\n  }\r\n\r\n  public getInternalData(): HeatData {\r\n    return {\r\n      min: this.min,\r\n      max: this.max,\r\n      data: Object.values(this.pointData)\r\n    }\r\n  }\r\n\r\n  public repaint() {\r\n    this.onExtremaChange()\r\n    this.renderer.renderAll(this.getInternalData())\r\n  }\r\n\r\n  private onExtremaChange() {\r\n    this.config.onExtremaChange && this.config.onExtremaChange({\r\n      min: this.min,\r\n      max: this.max,\r\n      gradient: this.config.gradient\r\n    })\r\n  }\r\n}\r\n\r\nexport default Store\r\n","import {\r\n  HeatData,\r\n  HeatmapConfig, PointInfo\r\n} from './typings'\r\nimport { mergeConfig } from './utils'\r\nimport Canvas2dRenderer from './canvas2d'\r\nimport Store from './store'\r\n\r\nclass Heatmap {\r\n  public config: HeatmapConfig\r\n  private store: Store\r\n  private renderer: Canvas2dRenderer\r\n\r\n  constructor(config: HeatmapConfig) {\r\n    this.config = mergeConfig(config)\r\n    this.renderer = new Canvas2dRenderer(this.config)\r\n    this.store = new Store(this.config, this.renderer)\r\n  }\r\n\r\n  public addData(data: PointInfo | PointInfo[]): Heatmap {\r\n    this.store.addData(data)\r\n    return this\r\n  }\r\n\r\n  public setData(data: HeatData): Heatmap {\r\n    this.store.setData(data)\r\n    return this\r\n  }\r\n\r\n  public setExtremum(min: number, max: number): Heatmap {\r\n    this.store.setExtremum(min, max, true)\r\n    return this\r\n  }\r\n\r\n  public repaint() {\r\n    this.store.repaint()\r\n    return this\r\n  }\r\n\r\n  public getDataURL(): string {\r\n    return this.renderer.getDataURL()\r\n  }\r\n\r\n  public getCanvas(): HTMLCanvasElement {\r\n    return this.renderer.canvas\r\n  }\r\n}\r\n\r\nexport default Heatmap\r\n"],"names":["defaultConfig","gradient","maxOpacity","minOpacity","blur","container","mergeConfig","customConfig","Object","assign","getColorPalette","config","gradientConfig","paletteCanvas","document","createElement","paletteCtx","getContext","width","height","createLinearGradient","keys","forEach","key","addColorStop","fillStyle","fillRect","getImageData","data","pointRound","num","Math","round","getXY","point","pos","position","left","top","compareArea","source","target","mergeInfo","value","getPointTemplate","blurFactor","globalAlpha","tplCanvas","tplCtx","sideLen","max","radius","scale","beginPath","arc","PI","fill","createRadialGradient","Canvas2dRenderer","constructor","canvas","shadowCanvas","ctx","min","templates","palette","setStyles","style","appendChild","computed","window","getComputedStyle","replace","className","cssText","backgroundColor","clear","clearRect","drawAlpha","heatData","points","templateAlpha","tpl","colorize","drawImage","img","imgData","i","length","alpha","offset","finalAlpha","computeAlpha","putImageData","opacity","renderPartial","renderAll","getDataURL","toDataURL","Store","renderer","pointData","inferRect","defaultRect","organiseData","x","y","prev","addData","Array","isArray","newPd","values","repaint","setData","setExtremum","render","getInternalData","onExtremaChange","Heatmap","store","getCanvas"],"mappings":"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"}